# 体調予測アプリ — 要件定義書

> **プロジェクト名**: Health Predictor
> **作成日**: 2026-02-10
> **ステータス**: MVP開発中

-----

## 1. プロジェクト概要

日々の生活データ（体調・睡眠・歩数・ストレス）を記録し、個人専用の機械学習モデルで**今日の体調低下リスクを予測する**モバイルアプリ。

### 背景・課題

体調の波は多くの人が経験するが、事前に気づくのは難しい。特に睡眠不足や疲労の蓄積による体調悪化は、前日までのデータに兆候が現れることが多い。本アプリはその兆候を機械学習で検出し、ユーザーの行動調整を支援する。

### ターゲットユーザー

- 体調の波に悩んでいる人
- コンディション管理をしたい人
- 日々の体調を記録・振り返りたい人

-----

## 2. 機能要件

### 2.1 データ入力

|項目          |必須/任意|入力方法                                 |
|------------|-----|-------------------------------------|
|体調スコア（1〜5段階）|必須   |顔アイコン1タップ                            |
|睡眠（就寝・起床時刻） |必須   |Apple Health / Google Fit 自動取得 or 手入力|
|歩数          |必須   |Apple Health / Google Fit 自動取得 or 手入力|
|ストレス（1〜5段階） |任意   |数値タップ                                |

- 直近3日分の記録を遡って編集可能（入力忘れの補完・ミスの修正に対応）
- 全項目（体調・睡眠・歩数・ストレス）が編集対象
- 4日以上前のデータは閲覧のみ（学習品質への影響を防止）

### 2.2 予測機能

|機能      |開放条件             |出力            |
|--------|-----------------|--------------|
|今日の不調リスク|体調入力14日以上        |不調確率（%）       |
|3日間リスク  |60日以上 AND 不調10件以上|72時間以内の不調確率（%）|

- 個人のデータのみで学習する専用モデル
- 毎日深夜にバッチ学習・予測を自動実行
- 信頼度を3段階（低・中・高）で表示
- **不調の基準をユーザーに明示**: 予測カードに「あなたの基準: 体調○以下」を要約表示、分析タブに14日平均・不調閾値・不調日数の詳細を表示

### 2.3 改善アドバイス

予測リスクが高い場合、ユーザーが**今日〜明日に変えられる行動**に限定して、**個人データに基づく具体的な数値付きアドバイス**を最大2件表示する。

|対象パラメータ|アドバイス例                                      |
|-------|--------------------------------------------|
|睡眠時間   |「あなたの好調日は平均7.2時間の睡眠です。今夜は23:00頃までに就寝がおすすめです」|
|歩数     |「8,000歩以上の日は体調が安定する傾向があります」                 |
|ストレス   |「ストレスLv3以下の日は不調率が15%低くなっています」               |

- 好調日・不調日の統計量から推奨値を自動算出（「あなたの場合」の個人化）
- 睡眠は推奨睡眠時間に加え、推奨就寝時刻・リスク低下率も提示
- 曜日・過去の体調など変えられないパラメータはアドバイス対象外

### 2.4 特徴量寄与度の表示

「なぜこの予測になったのか」を説明するため、今日の予測に影響した要因TOP3を表示する。

- ロジスティック回帰: 標準化済み係数×特徴量値で計算
- LightGBM: SHAP値で計算
- リスク増加方向は赤系、低下方向は緑系で色分け表示

### 2.5 データ可視化

**体調×特徴量 比較グラフ:**

- 左軸に体調スコア（1〜5）、右軸にユーザーが選んだ特徴量を重ねて表示
- 全学習特徴量を選択肢として表示（モデルの透明性を確保）
- 特徴量ごとにスケールを自動調整（固定範囲 or 個人データのパーセンタイル）

**睡眠パターン専用グラフ:**

- 就寝〜起床をバー表示で可視化（時刻の性質が数値と異なるため分離）
- 推奨睡眠時間以上は緑系、未満はオレンジ系で色分け

**その他:**

- 直近7日間の記録一覧（体調・睡眠・歩数）
- 学習進捗ステータス表示

### 2.6 段階的開放

データの蓄積量に応じて機能を段階的に開放し、精度が不十分な予測をユーザーに見せない設計。

|フェーズ    |条件               |表示内容       |
|--------|-----------------|-----------|
|データ収集中  |14日未満            |「学習中（あと○日）」|
|今日のリスク開放|14日以上            |不調確率を表示    |
|3日リスク開放 |60日以上 AND 不調10件以上|3日リスクを追加表示 |

-----

## 3. 非機能要件

|項目    |要件                           |
|------|-----------------------------|
|対応OS  |iOS / Android                |
|入力所要時間|1日あたり30秒以内                   |
|予測更新  |毎日 03:30 JST にバッチ実行          |
|データ保存 |Firebase Firestore（リアルタイム同期） |
|認証    |MVP段階は固定UID、将来Firebase Auth導入|

-----

## 4. 技術スタック

|レイヤー   |技術                      |
|-------|------------------------|
|フロントエンド|Flutter（Dart）           |
|データベース |Firebase Firestore      |
|バッチ処理  |Cloud Run（Python）       |
|初期モデル  |ロジスティック回帰（scikit-learn） |
|拡張モデル  |LightGBM（条件達成後、AUCで自動比較）|

-----

## 5. ML設計のポイント

### 特徴量

ユーザーの入力負担を増やさず、既存データからの**派生特徴量**で予測力を確保する。

- 体調の時系列: 前日スコア、3日/7日移動平均、前日差分、14日平均偏差
- 生活データ: 睡眠時間、歩数（前日値）、睡眠/歩数の偏差
- カレンダー: 曜日、休日フラグ
- リーク防止: 当日(t)の体調は予測入力に使わない（t-1以前のみ）

### 不調の定義

- 過去14日の体調平均より**1段階以上低い日**を不調と定義
- 個人の「普段の体調」を基準にするため、ユーザーごとに閾値が異なる

### モデル選択

- 60日未満: ロジスティック回帰のみ
- 60日以上: ロジスティック回帰とLightGBMを両方学習し、検証AUCが高い方を自動採用
- 少量データではシンプルなモデルの方が安定するケースが多いため、自動比較方式を採用

### ハイパーパラメータ・正則化の段階設計

データ量に応じてパラメータを自動切替し、過学習を防ぎつつモデルの柔軟性を確保する。

|データ量   |ロジ回帰 正則化(C)|LightGBM max_depth / num_leaves|
|-------|-----------|-------------------------------|
|14〜59日 |0.1（強）     |使用しない                          |
|60〜149日|0.5（やや強）   |3 / 8                          |
|150日以上 |1.0（標準）    |5 / 31                         |

-----

## 6. 画面構成（Bottom Navigation 4タブ）

```
[ホーム]        [データ]         [分析]          [設定]
│               │               │               │
├ 予測カード     ├ 期間切替       ├ 要因TOP3      ├ ヘルスケア連携
├ 体調入力(5段階) ├ 体調×特徴量    ├ アドバイス     ├ 通知設定
├ 記録サマリー   │  グラフ       ├ 週次FB導線    ├ プライバシー
│ └→詳細入力    ├ 睡眠パターン   └ モデル情報    └ アカウント
├ ステータス     │  グラフ
├ 要因/助言(要約) ├ 日次一覧
│ └→分析タブへ   │ └→日別編集
└ 7日ミニカード     (直近3日)
  └→データタブへ
```

**主要な遷移：**

- ホーム → 記録サマリータップ → 詳細入力画面（push → 保存でpop）
- ホーム → 「もっと見る」→ 分析タブへ切替
- データ → 一覧タップ → 日別詳細/編集（直近3日のみ編集可）

-----

## 7. 将来の拡張候補

- 7日間予測
- 週次/月次レポート
- 詳細分析ダッシュボード
- 共通モデル＋個人差分によるスケール対応