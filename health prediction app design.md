# 体調予測アプリ：最終設計ドキュメント

> **バージョン**: v2.0（Claude・ChatGPT レビュー反映済）
> **作成日**: 2026-02-06
> **ステータス**: MVP設計確定 → 実装フェーズへ移行

-----

## 1. アプリの目的

日々の生活データ（睡眠・歩数・ストレス・体調）から、**「今日」の体調低下リスクを予測する**個人向けアプリを開発する。

ユーザーが不調の兆候を事前に把握し、以下の意思決定をサポートする：

- 無理な予定を避ける
- 生活リズムを調整する

> **変更点**: 元の設計では「今日」と「今後3日」を同時に提供する予定だったが、MVP段階では**今日のリスクのみ**を開放する。3日リスクはUIを用意するが、開放は段階的に行う（後述）。

-----

## 2. ターゲットユーザー

- 体調の波に悩んでいる人
- コンディション管理をしたい人
- 日々の体調を記録したい人

-----

## 3. 提供する価値

1. **個人専用の体調予測** — 自分のデータから学習した予測モデル
1. **不調の”予報”による行動調整** — 予測結果に基づく事前対策
1. **体調データの蓄積と振り返り** — 記録の可視化・傾向把握

-----

## 4. 予測の基本設計

### 出力

|予測種別  |内容                     |MVP開放条件              |
|------|-----------------------|---------------------|
|今日のリスク|今日の不調確率（%）             |体調入力14日分             |
|3日リスク |今後72時間以内に1回でも不調になる確率（%）|体調入力60日以上 AND 不調10件以上|

### 目的変数

2値分類：不調フラグ（0 or 1）

### 不調の定義

- 過去14日の体調平均と比較
- **「平均より1段階以上低い日」を不調とする**

### 14日未満の期間（初期ルール）

- `daysCollected < 14` の期間は `y_today` を生成しない（学習行を作らない）
- UIは「学習中」のみ表示
- 14日分のデータが溜まった時点で初めて不調ラベルの生成と予測を開始する

### 3日リスクのラベル設計

```
y_3d(t) = OR(y(t+1), y(t+2), y(t+3))
```

- 72時間以内に1回でも不調があれば正例
- ピンポイントの t+3 予測は行わない（精度が不安定なため）

> **変更理由**: 期間ラベル方式の方が正例数が増えて学習が安定し、ユーザー体験としても「この先3日間で体調を崩すリスクがあります」の方が自然で行動変容につながりやすい。

-----

## 5. 予測対象の設計

### 今日のリスク

- 入力：当日朝までのデータ
- 出力：今日の不調確率

### 3日間の期間リスク

- 入力：当日朝までのデータ
- 出力：今後72時間以内に一度でも不調になる確率

### 「当日朝までのデータ」の定義

- `x(t)` は **date_key=t の睡眠（起床日の睡眠）＋ t-1 までの体調・歩数・ストレス**で構成する
- 歩数は t 当日はまだ増えるため、原則 `steps(t-1)` を使用する
- 睡眠のみ date_key=t（当日起床分）を使える（起床時点で確定しているため）

### 予測機能の段階的開放

|フェーズ          |開放条件             |表示            |
|--------------|-----------------|--------------|
|データ収集中        |14日未満            |「学習中」「あと○日で開放」|
|今日のリスク開放      |14日以上            |今日の不調確率を表示    |
|3日リスク開放       |60日以上 AND 不調10件以上|3日リスクを表示      |
|3日リスク未開放（条件未達）|60日以上だが不調が少ない    |「準備中」「あと○日」表示 |

-----

## 6. 特徴量設計

### 必須（入力ゼロで計算可能な派生特徴量を含む）

**基本特徴量：**

- 睡眠時間
- 歩数
- 曜日
- 休日フラグ（**MVPは `is_weekend`（土日）のみ**。祝日対応は将来、日本祝日カレンダー or APIで追加）

**体調の時系列特徴量（入力負担ゼロ・MVP必須）：**

- `mood(t-1)`：前日の体調スコア
- `ma3(t-1)`：t-1時点の3日移動平均
- `ma7(t-1)`：t-1時点の7日移動平均
- `delta1(t-1) = mood(t-1) - mood(t-2)`：t-1時点の前日差分
- `dev14(t-1) = mood(t-1) - ma14(t-1)`：t-1時点の14日平均との偏差

> **⚠️ リーク防止ルール**: x(t) に使ってよい体調系は **t-1以前のみ**。特徴量は全部「t-1時点で確定しているもの」に揃える。`mood(t)` はラベル生成・表示には使うが、予測入力には絶対に入れない。

**睡眠・歩数の偏差特徴量（入力負担ゼロ）：**

- `sleep_dev`：直近平均睡眠時間との差
- `steps_dev`：直近平均歩数との差

### 任意

- ストレス（ユーザー入力）

> **設計意図**: ユーザー入力負担を増やさず、既存データからの派生特徴量で予測力を高める。体調スコアの時系列特徴量は最も予測力が高いと想定される（体調悪化は前日から兆候が出やすい）。

-----

## 7. 日付基準

- 起床日をその日の睡眠として扱う
- 例：2/5 23:40 〜 2/6 06:30 → 2/6 の睡眠として扱う

### date_key の定義

- `date_key` は**起床時刻を端末ローカルTZに変換した `YYYY-MM-DD`**
- Firestore に保存する timestamp は**UTC**
- 併せて `tz_at_wake`（例: `Asia/Tokyo`）を内部保存する（ユーザー非表示）

> **設計根拠**: 海外移動や端末TZ変更時にdate_keyがズレる事故を防止する。

-----

## 8. 入力設計

### 毎日入力（必須）

- **体調（5段階）** — 顔アイコン等で1タップ入力

> **変更点**: 3段階 → 5段階に確定。3段階だと「普通」に集中し分散が小さくなるため、予測精度に悪影響。UIは「5段階だけど1タップ」で負担が増えないよう設計する。

### 任意入力

- ストレス

### 睡眠

- **Apple Health / Google Fit から自動取得**（無料機能として提供）
- 連携できない場合：就寝時刻・起床時刻を手入力

### 歩数

- **Apple Health / Google Fit から自動取得**（無料機能として提供）
- 連携できない場合：手入力

### 過去データの編集

ユーザーが直近3日分の記録を遡って編集できる機能を提供する。

**仕様：**

|項目    |内容                   |
|------|---------------------|
|編集可能期間|直近3日まで（今日を含む）        |
|編集対象  |全項目（体調スコア・睡眠・歩数・ストレス）|
|導線    |日次一覧の各行をタップ → 編集画面   |

**編集時の挙動：**

- 既存データをプリセットした入力画面を開く
- 保存時に `updatedAt` を更新（バッチ対象ユーザー抽出に反映される）
- 体調スコアの変更時は `daysCollected` の再計算は不要（既にカウント済みの日の編集のため）
- 未入力日への新規入力も同じ画面で可能（入力忘れの補完）

**4日以上前のデータ：**

- 閲覧は可能だが編集はできない（UIでグレーアウト or 編集ボタン非表示）
- 古いデータの改変はモデルの学習品質に大きく影響するため制限

> **設計根拠**: 記録忘れや入力ミスの修正ニーズに対応する。3日に制限する理由は、(1) 記憶が正確なうちに修正できる範囲、(2) 古いデータの改変による学習への悪影響を防ぐ、(3) UIをシンプルに保つ。

-----

## 9. 欠損値の扱い

### 体調（目的変数）

- 未入力日は学習に使わない

### 特徴量

- 過去7日平均で補完
- `*_missing` フラグを付与（欠損自体が情報になるケースをカバー）

-----

## 10. モデル設計

### 初期（MVP）

- **ロジスティック回帰**（確率出力・解釈可能・軽量）
- ベースラインモデルとして継続利用

### ハイパーパラメータ・正則化の段階設計

データ量に応じてパラメータを切り替える。少量データでは正則化を強くしてモデルを単純に保ち、データが増えたら柔軟にする。

**ロジスティック回帰：**

|データ量   |正則化強度 (C)|正則化種類|根拠                             |
|-------|---------|-----|-------------------------------|
|14〜59日 |0.1（強め）  |L2   |少量データで過学習を防ぐ                   |
|60〜149日|0.5（やや強め）|L2   |データ増加に合わせ少し柔軟に                 |
|150日以上 |1.0（標準）  |L2   |標準的なバランス。300件程度ではこれ以上緩めると過学習リスク|

**LightGBM（60日以上で使用）：**

|データ量    |max_depth|num_leaves|n_estimators|min_child_samples|learning_rate|
|--------|---------|----------|------------|-----------------|-------------|
|60〜149日 |3        |8         |100         |5                |0.1          |
|150〜299日|4        |16        |150         |5                |0.05         |
|300日以上  |5        |31        |200         |3                |0.05         |


> **設計根拠**: 個人データ60〜200件の規模でOptunaなどの自動チューニングを毎日回すのは過学習リスクが高く、バッチ時間も増加する。データ量ベースの段階切替は安定性とパフォーマンスのバランスが良い。各パラメータはKaggle経験則と少量データでの実験知見に基づく。

### LightGBM の導入条件と切替ロジック

|条件         |値                     |
|-----------|----------------------|
|データ日数      |60日以上                 |
|不調フラグ(1)の件数|10件以上                 |
|判定         |**AND条件**（両方を満たした場合のみ）|

**切替ロジック（重要）：**

条件達成は「LGBMに切り替える」ではなく、**「LGBMを試せる条件が整った」という意味**。少量データ（60〜120日程度）ではロジスティック回帰の方が安定するケースが普通にあるため、以下の手順で判定する：

1. 初期（条件未達）：ロジスティック回帰のみ
1. 条件達成（60日 AND 不調10件）：ロジスティック回帰と LightGBM を**両方学習**
1. 検証スコア（時系列分割でのAUC等）が良い方を採用
1. 採用モデルを `model_status.modelType` に記録

**検証の分割方法：**

データ量に応じて検証サイズを段階的に調整する。直近データを検証に使うことでリーク防止を担保しつつ、少量データ時の学習データ不足と大量データ時の「直近を学習に使えない」問題を両方回避する。

|データ量  |検証サイズ    |根拠                     |
|------|---------|-----------------------|
|14〜29日|20%（最低3日）|データが少ないので割合ベースで学習データを確保|
|30〜99日|7日       |1週間分で曜日パターンをカバー        |
|100日以上|14日      |2週間分で安定した評価            |

- 指標：AUC（＋可能なら PR-AUC もログ出力）
- rolling window 検証は将来の改善として検討

> **設計根拠**: 固定14日だと少量データ時に学習データが不足する（例: 20日で学習6件）。割合固定（例: 20%）だと大量データ時に直近が大量に学習から外れる（例: 300日で直近60日が検証）。体調データは最近のパターンが最も重要なので、直近を必要以上に学習から外すのは予測精度に悪影響。段階設計がバランスが良い。

- 検証は毎日のバッチで自動判定し、より良い方を `predictions` に反映
- **条件未達の場合**（例：60日で不調3件）はロジスティック回帰のまま維持し、UXは「体調が安定しています」というポジティブなメッセージに変換

> **設計根拠**: 「LGBMの方が高性能だから常に強い」は半分正しく半分間違い。少量データでは単純で頑健なモデルの方がUX的に強いケースが多い。LGBMが安定してロジ回帰を上回り始める目安は総サンプル150〜300件以上・不調クラス20件以上（経験則）。条件達成時点（60日）では拮抗〜ロジ有利のことが多いため、自動比較方式を採用する。

### 不均衡データへの対処方針

このアプリでは出力が確率値であり、閾値（0.5）で二値判定する場面がない。そのため不均衡の悪影響は相対的に小さい。対処は「問題が出てから入れる」順序で行う。

**運用方針：**

- MVP（ロジスティック回帰）はまず `class_weight=None` で学習
- 出力確率が極端に低くレンジが潰れる（例：ほぼ 0.05〜0.15 に集中）など「分離が弱い」兆候が出たら `class_weight='balanced'` を試す
- LightGBM も同様に、まずデフォルトで学習し、必要なら `scale_pos_weight` 等を導入
- 不均衡対策の評価は**偽陽性増加（元気なのに高リスク）を特に重く見る**（離脱リスクが高いため）

**手法の優先度：**

|手法             |評価                         |
|---------------|---------------------------|
|何もしない（デフォルト）   |◎ まず試す                     |
|クラス重み付け        |○ 確率分布が潰れたら導入              |
|アンダーサンプリング＋バギング|△ データ180日以上・不調30件以上で検討     |
|SMOTE          |× 非推奨（個人×時系列データでは人工サンプルが有害）|


> **設計根拠**: このアプリでは「不調です」と言われて元気だった（偽陽性）方が、「大丈夫です」と言われて体調を崩した（偽陰性）よりもユーザーの信頼を損ねやすく離脱に直結する。重み付けは偽陽性を増やすリスクがあるため、必要性が確認されてから導入する。

### 学習方式

- 個人ごとのモデル
- 毎日1回再学習（深夜バッチ）

### スケール時の移行パス

- 初期：個人モデル（少数ユーザー想定）
- 成長期：共通モデル＋個人平均との差分特徴量でスケール
- 将来：個人モデルは選択式（高精度モード）として有料化検討
- **設計上の注意**: Cloud Runの実装を「ユーザー単位で処理」ではなく「パイプラインを差し替え可能」にしておく

-----

## 11. 信頼度（Confidence）設計

### 設計方針

予測が外れたときのユーザー離脱を防ぐため、予測確率と同時に**信頼度**を表示する。

### MVP段階：ルールベースのみ（3段階）

|信頼度|条件                  |
|---|--------------------|
|低  |データ30日未満 OR 不調5件未満  |
|中  |データ30〜59日 AND 不調5件以上|
|高  |データ60日以上 AND 不調10件以上|

- 直近7日の入力欠損率が30%以上の場合 → 1段階ダウン
- `model_status` に `unhealthyCount` と `recentMissingRate` を追加して管理

### 表示方針（統合UI）

|信頼度|表示                      |
|---|------------------------|
|低  |「参考値です」表示に固定（確率の尖り具合は無視）|
|中以上|確率の尖り具合でニュアンスを追加（将来）    |

### 将来の拡張：確率の尖り具合

- モデル出力確率が 0.4〜0.6 の範囲 → 「判断が微妙なゾーン」のニュアンスを追加
- **ルールベース信頼度** = モデル全体の成熟度
- **確率の尖り具合** = 今日の予測の確信度
- 実装はユーザーフィードバックで「予測が曖昧でわからない」という声が出てから（YAGNI）

### 表示例

```
信頼度：高 × 確率が尖っている
→ 「不調リスク：高め」

信頼度：高 × 確率が0.5付近
→ 「不調リスク：やや注意（微妙なラインです）」

信頼度：低 × どんな確率でも
→ 「不調リスク：○%（まだ学習中の参考値です）」
```

-----

## 12. 改善アドバイスの自動生成

### 目的

リスク表示だけでは「じゃあどうすればいい？」が分からない。ユーザーが**今日〜明日に変えられる行動**に限定して、**具体的な数値付きの改善アドバイス**を提示する。

### 対象パラメータ（可変なもののみ）

|パラメータ|アドバイス例                                               |
|-----|-----------------------------------------------------|
|睡眠時間 |「あなたの場合、7時間以上の睡眠でリスクが下がる傾向があります。今夜は23:00までに就寝がおすすめです」|
|歩数   |「8,000歩以上の日は体調が安定する傾向があります」                          |
|ストレス |「ストレスLv3以下の日は不調率が15%低くなっています」                        |


> **対象外**: 曜日・過去の体調スコアなどユーザーが変えられないものはアドバイスに含めない。

### 生成ロジック

バッチ処理時に、各可変特徴量について以下を計算する：

1. **個人の統計量を算出**: 好調日(y=0)と不調日(y=1)の各特徴量の平均・分布を比較
1. **最適閾値の推定**: 好調日のデータから「リスクが低い行動水準」を算出（好調日の25パーセンタイル値）
1. **ギャップ検出**: 今日の値が「最適水準」から離れている特徴量を抽出
1. **具体的アドバイス生成**: 最適水準の数値と、推奨就寝時刻を含むテンプレートメッセージを生成

```
例:
- 好調日の睡眠: 平均7.2h / 25パーセンタイル6.5h
- 不調日の睡眠: 平均5.8h
- 今日の睡眠: 5.5h → ギャップ大
- 好調日の就寝時刻: 平均23:10
→ 「あなたの好調日は平均7.2時間の睡眠を取っています。
    今夜は23:00頃までに就寝すると、明日のリスクが下がる傾向があります」
```

### 睡眠の具体的アドバイス設計

睡眠は最も行動変容に繋がりやすいため、特に詳細に設計する：

|分析項目  |計算方法                    |アドバイスへの反映       |
|------|------------------------|----------------|
|推奨睡眠時間|好調日の平均睡眠時間              |「○時間以上の睡眠がおすすめ」 |
|推奨就寝時刻|好調日の平均就寝時刻              |「○時頃までに就寝を」     |
|リスク低下率|推奨水準以上の日の不調率 vs 未満の日の不調率|「不調率が○%低くなっています」|

### Firestore 保存

`predictions/{date_key}` に `advice` フィールドを追加：

```json
{
  "advice": [
    {
      "feature": "sleep_hours",
      "message": "あなたの好調日は平均7.2時間の睡眠です。今夜は23:00頃までに就寝がおすすめです",
      "detail": {
        "targetValue": 7.2,
        "currentValue": 5.5,
        "recommendedBedtime": "23:00",
        "riskReduction": "不調率が30%低下"
      },
      "priority": 1
    }
  ]
}
```

### 表示ルール

- 予測機能が開放済み（14日以上）の場合のみ表示
- アドバイスは**最大2件**（情報過多を防ぐ）
- リスクが低い日（例: 15%以下）はアドバイスなし（「良い調子です」のみ）
- 好調日のデータが10日未満の場合、具体的な数値は出さずテンプレートメッセージのみ

-----

## 13. 特徴量の寄与度表示

### 目的

「なぜこの予測になったのか」をユーザーに説明することで、予測への納得感と信頼を高める。

### 実装方式

|モデル      |寄与度の算出方法           |
|---------|-------------------|
|ロジスティック回帰|標準化済み係数 × 今日の特徴量値  |
|LightGBM |SHAP値（`shap` ライブラリ）|

### バッチ処理での計算

ロジスティック回帰の場合：

```python
# 標準化済み係数 × 標準化済み特徴量 = 各特徴量の寄与度
contributions = scaler.transform(X_today) * model.coef_[0]
```

LightGBMの場合：

```python
import shap
explainer = shap.TreeExplainer(model)
shap_values = explainer.shap_values(X_today)
```

### Firestore 保存

`predictions/{date_key}` に `contributions` フィールドを追加：

```json
{
  "contributions": [
    {"feature": "sleep_hours", "label": "睡眠時間", "value": -0.35, "direction": "negative"},
    {"feature": "mood_t1", "label": "前日の体調", "value": 0.28, "direction": "positive"},
    {"feature": "steps_t1", "label": "昨日の歩数", "value": -0.15, "direction": "negative"}
  ]
}
```

- `value`: 寄与度（正=リスク増加方向、負=リスク低下方向）
- 上位3件のみ保存（UIの見やすさ優先）

### 表示方針

- 「今日の予測に影響した要因 TOP3」として表示
- 正方向（リスク増加）は赤系、負方向（リスク低下）は緑系で色分け
- ユーザー向けラベル（`sleep_hours` → 「睡眠時間」）に変換して表示

### 特徴量のユーザー向けラベル対応表

|特徴量        |ユーザー向けラベル|
|-----------|---------|
|sleep_hours|睡眠時間     |
|steps_t1   |昨日の歩数    |
|mood_t1    |前日の体調    |
|ma3_t1     |直近3日の体調傾向|
|ma7_t1     |直近7日の体調傾向|
|delta1_t1  |体調の変化    |
|dev14_t1   |普段との体調差  |
|sleep_dev  |普段との睡眠差  |
|steps_dev  |普段との歩数差  |
|day_of_week|曜日       |
|is_weekend |休日かどうか   |
|stress_val |ストレス     |

-----

## 14. データ可視化（グラフ設計）

### 14.1 体調 × 特徴量 比較グラフ

ユーザーが体調と任意の特徴量を重ねて時系列で確認できるグラフ。モデルが何を学習しているかの透明性を確保する。

**仕様：**

- 横軸：日付（直近7日 / 30日 / 全期間を切替可能）
- 左軸：体調スコア（1〜5、固定）
- 右軸：ユーザーが選択した特徴量（自動スケール）
- 特徴量は**全学習特徴量を選択肢として表示**（透明性重視）

**期間別の表示方法：**

|期間 |データポイント             |表示の工夫                 |
|---|--------------------|----------------------|
|7日 |日ごとのプロット            |各日のラベルを表示、詳細が見やすい     |
|30日|日ごとのプロット + 7日移動平均ライン|日次の変動と週単位の傾向を両方把握できる  |
|全期間|日ごとのプロット + 7日移動平均ライン|横軸ラベルは月単位に間引き、長期傾向の把握用|

- 30日・全期間では**7日移動平均を半透明の太線で重ねる**ことで、日次のノイズに埋もれずに傾向が見える
- 全期間で横軸が長くなる場合、ピンチズームでの拡大・縮小を対応

**選択可能な特徴量とスケール：**

|特徴量        |表示名      |取りうる範囲   |備考         |
|-----------|---------|---------|-----------|
|sleep_hours|睡眠時間     |0〜12h    |           |
|steps_t1   |昨日の歩数    |0〜30,000 |個人の最大値で上限調整|
|stress_val |ストレス     |1〜5      |体調と同スケール   |
|mood_t1    |前日の体調    |1〜5      |           |
|ma3_t1     |直近3日の体調傾向|1〜5      |           |
|ma7_t1     |直近7日の体調傾向|1〜5      |           |
|delta1_t1  |体調の変化    |-4〜+4    |0を中心に表示    |
|dev14_t1   |普段との体調差  |-4〜+4    |0を中心に表示    |
|sleep_dev  |普段との睡眠差  |-6〜+6h   |0を中心に表示    |
|steps_dev  |普段との歩数差  |動的       |0を中心に表示    |
|day_of_week|曜日       |0(月)〜6(日)|           |
|is_weekend |休日       |0 or 1   |           |

**スケール自動調整ルール：**

- 固定範囲がある特徴量（体調、ストレス等）はその範囲を使用
- 歩数のように範囲が個人差大きい特徴量は、個人データの5パーセンタイル〜95パーセンタイルで上下限を設定
- 偏差系（差分・dev系）は0を中心に±最大絶対値で対称にスケーリング

### 14.2 睡眠パターングラフ（専用）

就寝・起床時刻は数値特徴量とスケールが異なるため、別グラフで可視化する。

**仕様：**

- 横軸：日付
- 縦軸：時刻（0:00〜24:00、上下反転で深夜が上に来る表示も検討）
- 就寝時刻を棒の下端、起床時刻を棒の上端として、睡眠時間をバー表示
- 色分け：睡眠時間が推奨値（好調日の平均）以上なら緑系、未満ならオレンジ系

```
例:
  24:00 ┤
  23:00 ┤ ██   ██
  22:00 ┤ ██   ██ ██
   ...  
   7:00 ┤ ██   ██ ██ ██
   6:00 ┤      ██ ██ ██
        └──────────────
         月  火  水  木
```

-----

## 15. 外れた日のフォロー設計

### 目的

- 予測外れによる離脱を防ぐ
- フィードバックデータで予測改善を加速

### 実装方針

- **毎日の通知で聞くのは避ける**（入力負担で離脱リスク）
- **週次まとめ入力の導線に1タップフィードバックを組み込む**

```
「先週の予報、実際はどうでした？」
[当たった] [外れた] [わからない]
```

-----

## 16. UI設計（画面構成）

### ナビゲーション: Bottom Navigation 4タブ

|タブ |目的        |アイコン|
|---|----------|----|
|ホーム|今日の行動を整える |🏠   |
|データ|履歴を見る・編集する|📊   |
|分析 |予測の根拠を理解する|🔍   |
|設定 |アプリの設定    |⚙️   |

### 1) ホーム（今日の体調を整えるための画面）

ユーザーが毎日最初に開く画面。スクロール量を減らし、カード型で構成する。

**上から順に：**

|要素                  |内容                               |備考                 |
|--------------------|---------------------------------|-------------------|
|(1) 今日の予測カード        |不調リスク（%）、信頼度、3日リスク（条件達成後）、不調基準の要約|14日未満は「学習中（あと○日）」表示|
|(2) 体調入力            |顔5段階の1タップ入力                      |入力の主役、現在のUIをそのまま使用 |
|(3) 今日の記録サマリー       |睡眠/歩数/ストレスの入力状況をチップ表示            |タップで詳細入力画面へ遷移      |
|(4) 学習ステータスバナー      |「あと○日で開放」                        |14日以上でバナー変更        |
|(5) 要因TOP3・アドバイス（要約）|要因TOP3を簡易表示、アドバイス最大2件            |「もっと見る」で分析タブへ      |
|(6) 直近7日ミニカード       |小さなミニグラフ + 「データへ」ボタン             |詳細グラフはデータタブに移動     |

### 2) 詳細入力画面（モーダル / push画面）

ホームの「今日の記録サマリー」タップから遷移。

|要素  |内容                    |
|----|----------------------|
|上部  |日付 + 入力状態（自動取得 / 手入力） |
|カード1|睡眠（時刻ピッカー or 自動取得値の表示）|
|カード2|歩数（自動取得 or 手入力）       |
|カード3|ストレス（1〜5、任意）          |
|下部  |保存ボタン                 |

- ヘルスケア連携済みなら自動取得値を表示、未連携なら手入力フォーム
- 各カードに「自動取得できませんでした → 手入力」の分岐を用意

### 3) データ（履歴を見る画面）

|要素       |内容                              |
|---------|--------------------------------|
|期間切替     |7日 / 30日 / 全期間                  |
|体調×特徴量グラフ|左軸: 体調、右軸: ユーザー選択の特徴量（セクション14.1）|
|睡眠パターングラフ|就寝〜起床バー表示（セクション14.2）            |
|日次一覧     |新→古順、タップで日別詳細/編集へ               |

**過去データ編集の導線：**

- 一覧の各行をタップ → 日別詳細画面
- 直近3日以内の行は「編集」ボタンを表示
- 4日以上前の行は閲覧のみ（編集ボタン非表示 or グレーアウト）

### 4) 分析（予測の根拠を理解する画面）

|要素       |内容                                |
|---------|----------------------------------|
|不調の基準    |あなたの「不調」の定義を数値で表示（詳細）             |
|要因TOP3   |今日の予測に影響した特徴量（赤/緑で方向表示）           |
|アドバイス    |最大2件、具体的な数値付き                     |
|週次フィードバック|「先週の予報、実際はどうでした？」[当たった/外れた/わからない] |
|モデル情報    |使用モデル（logistic/lightgbm）、信頼度、データ日数|

**データ不足時の表示：**

- 14日未満: 「データを集めています。○日後に予測が始まります」
- 14日以上だが分析コンテンツが少ない場合: 要因TOP3とアドバイスのみ表示、フィードバックは週末に導線表示

### 不調の基準のユーザー向け表示

ユーザーが「何をもって不調としているのか」を理解できるよう、不調の定義を明示する。

**予測カード（ホーム）での要約表示：**

```
不調リスク: 42%
あなたの基準: 体調 2.8 以下の日
```

- 14日平均と不調閾値を1行で簡潔に表示
- タップで分析タブの詳細へ遷移

**分析タブでの詳細表示：**

```
┌─────────────────────────────────────┐
│ あなたの「不調」の基準               │
│                                     │
│ 普段の体調: 3.8（直近14日の平均）     │
│ 不調ライン: 2.8 以下                 │
│                                     │
│ この基準はあなたの入力データから       │
│ 毎日自動で更新されます。              │
│                                     │
│ 直近30日の不調日: 4日 / 30日         │
└─────────────────────────────────────┘
```

- 14日移動平均、不調閾値（平均-1）、直近の不調日数を表示
- 「あなた個人のデータが基準」であることを明示（他人と比較しない安心感）

**Firestore での保存：**

バッチ処理で `model_status/current` に以下を追加：

|フィールド             |内容                  |
|------------------|--------------------|
|moodMean14        |直近14日の体調平均          |
|unhealthyThreshold|不調閾値（moodMean14 - 1）|

### 5) 設定

|要素     |内容                                 |
|-------|-----------------------------------|
|ヘルスケア連携|Apple Health / Google Fit の接続ON/OFF|
|通知設定   |入力リマインダー等（将来）                      |
|プライバシー |学習データの確認・削除                        |
|アカウント  |ログイン/ログアウト（将来Firebase Auth導入時）     |

-----

### 画面遷移図

```
┌─────────────────────────────────────────────────────┐
│                 Bottom Navigation                    │
│  [ホーム]    [データ]    [分析]    [設定]              │
└────┬──────────┬──────────┬──────────┬────────────────┘
     │          │          │          │
     ▼          │          │          │
┌─────────┐    │          │          │
│ ホーム   │    │          │          │
│          │    │          │          │
│ 予測カード│    │          │          │
│ 体調入力 │    │          │          │
│ 記録サマリ├──push──┐     │          │
│ ステータス│        │     │          │
│ 要因/助言 ├─tap────│─────┤          │
│ 7日ミニ  ├─tap────│─┐   │          │
└─────────┘   │    │ │   │          │
              ▼    │ │   │          │
     ┌──────────┐  │ │   │          │
     │ 詳細入力  │  │ │   │          │
     │          │  │ │   │          │
     │ 睡眠     │  │ │   │          │
     │ 歩数     │  │ │   │          │
     │ ストレス  │  │ │   │          │
     │ [保存]   │  │ │   │          │
     └──┬───────┘  │ │   │          │
        │ pop      │ │   │          │
        ▼          │ │   │          │
     ホームに戻る    │ │   │          │
                   │ │   │          │
              ┌────┘ │   │          │
              ▼      │   ▼          ▼
         ┌─────────┐ │ ┌────────┐ ┌────────┐
         │ データ   │ │ │ 分析   │ │ 設定   │
         │         │ │ │        │ │        │
         │ 期間切替 │ │ │ TOP3   │ │ 連携   │
         │ 特徴量   │◀┘ │ 助言   │ │ 通知   │
         │ グラフ   │   │ FB導線 │ │ privacy│
         │ 睡眠グラフ│   │ モデル │ │ account│
         │ 一覧    │   └────────┘ └────────┘
         └──┬──────┘
            │ tap (直近3日)
            ▼
     ┌──────────┐
     │ 日別詳細  │
     │ /編集    │
     │          │
     │ 体調     │
     │ 睡眠     │
     │ 歩数     │
     │ ストレス  │
     │ [保存]   │
     └──────────┘
```

**遷移パターンまとめ：**

|起点                   |操作 |遷移先       |遷移方法|
|---------------------|---|----------|----|
|ホーム → 記録サマリー         |タップ|詳細入力画面    |push|
|ホーム → 要因/アドバイス「もっと見る」|タップ|分析タブ      |タブ切替|
|ホーム → 7日ミニカード「データへ」  |タップ|データタブ     |タブ切替|
|データ → 一覧の行（直近3日）     |タップ|日別詳細/編集画面 |push|
|データ → 一覧の行（4日以上前）    |タップ|日別詳細（閲覧のみ）|push|
|詳細入力 → 保存            |タップ|ホームに戻る    |pop |
|日別詳細 → 保存            |タップ|データに戻る    |pop |

-----

## 13. システム構成

### フロントエンド

- Flutter（iOS / Android）

### バックエンド

- Firebase Firestore（データ保存）

### 学習・推論

- Cloud Run（Python）
- **毎日 03:30 JST にバッチ実行**
- その日の `predictions/{today}` を生成（当日分）
- アプリ側は起床後にFirestoreから当日の予測結果を読み取って表示

**バッチ対象ユーザーの抽出：**

- 対象：`daily` が直近2日で更新されたユーザー（`updatedAt` で判定）
- それ以外はスキップ（非アクティブユーザーの無駄な処理を防止）

-----

## 14. データ構造（概要）

### 日次ログ

```
users/{uid}/daily/{date_key}
```

|フィールド     |内容                                        |
|----------|------------------------------------------|
|sleep     |就寝 / 起床 / 時間 / 取得方法                       |
|steps     |歩数                                        |
|stress    |ストレス（任意）                                  |
|moodScore |体調（5段階）                                   |
|tz_at_wake|起床時の端末タイムゾーン（例: `Asia/Tokyo`）※内部保存・ユーザー非表示|

### モデル状態

```
users/{uid}/model_status/current
```

|フィールド            |内容                           |カウント定義                   |
|-----------------|-----------------------------|-------------------------|
|daysCollected    |収集日数                         |`moodScore` が存在する日のみカウント |
|daysRequired     |必要日数                         |—                        |
|ready            |予測開放済みか                      |—                        |
|unhealthyCount   |不調フラグ(1)の累計件数                |不調ラベル `y=1` が生成された日のみカウント|
|recentMissingRate|直近7日の入力欠損率                   |—                        |
|modelType        |現在のモデル種別（logistic / lightgbm）|—                        |
|confidenceLevel  |信頼度（low / medium / high）     |—                        |

### 予測結果

```
users/{uid}/predictions/{date_key}
```

|フィールド       |内容                                |
|------------|----------------------------------|
|pToday      |今日の不調確率                           |
|p3d         |3日リスク確率（開放後のみ）                    |
|confidence  |信頼度（low / medium / high）          |
|generatedAt |予測生成タイムスタンプ（UTC）                  |
|modelVersion|使用モデル（例: `logistic_v1`, `lgbm_v1`）|

-----

## 15. 技術スタック

|レイヤー   |技術                     |
|-------|-----------------------|
|フロントエンド|Flutter                |
|データベース |Firebase Firestore     |
|学習・推論  |Cloud Run（Python）      |
|初期モデル  |ロジスティック回帰（scikit-learn）|
|段階モデル  |LightGBM（条件達成後）        |

-----

## 16. リリース方針

- 初回リリースは**全機能無料**（現在実装済みの機能すべて）
- ユーザー数と継続率を最優先で伸ばす
- 有料プランは**リリース後に追加する新機能**で構成（既存機能の有料化はしない）
- サブスクリプションは Apple / Google のアプリ内課金で提供

-----

## 17. プラン設計（3段階サブスクリプション）

### プラン一覧

|プラン   |月額    |年額（目安）  |ターゲット          |
|------|------|--------|---------------|
|無料    |¥0    |—       |全ユーザー          |
|スタンダード|¥480/月|¥4,800/年|データを深く分析したいユーザー|
|プレミアム |¥980/月|¥9,800/年|AIに健康相談もしたいユーザー|


> **価格設定根拠**: 国内ヘルスケアアプリの相場（あすけん¥480、FiNC¥480）を参考に、スタンダードは心理的ハードルの低い¥480に設定。プレミアムは¥980でAIチャットの価値を載せる。¥980を超えると個人アプリでは転換率が急落する。

### 無料プラン（現在の全機能）

リリース時点で実装済みの機能をすべて含む。

|カテゴリ|機能                                  |
|----|------------------------------------|
|記録  |体調5段階入力、睡眠・歩数・ストレス入力、ヘルスケア連携、直近3日編集 |
|予測  |今日の不調リスク（14日〜）、3日リスク（60日〜）、信頼度表示    |
|分析  |要因TOP3、具体的数値付きアドバイス、不調の基準表示         |
|可視化 |体調×特徴量グラフ（7日/30日/全期間）、睡眠パターングラフ、日次一覧|
|その他 |週次フィードバック                           |

### スタンダードプラン（¥480/月）

無料プランに加え、以下の分析・レポート機能を提供する。

|機能         |内容                         |
|-----------|---------------------------|
|週次レポート     |1週間の体調傾向・改善ポイントをまとめたレポート   |
|月次レポート     |月間の体調推移・生活習慣の分析サマリー（PDF出力可）|
|7日間予測      |今後7日間の不調リスク推移（条件: データ90日以上）|
|データエクスポート  |記録データのCSVダウンロード            |
|詳細分析ダッシュボード|特徴量ごとの体調への影響度、月間統計、曜日別傾向   |

### プレミアムプラン（¥980/月）

スタンダードプランに加え、AIヘルスチャット機能を提供する。

|機能         |内容                                |
|-----------|----------------------------------|
|AIヘルスチャット  |自身の健康データに基づいたパーソナライズされたAI相談（月30回） |
|個人モデル高精度モード|LightGBMのハイパーパラメータ自動チューニング（Optuna）|

### AIヘルスチャットの設計

**概要：**

ユーザーの体調データ・予測結果・寄与度をコンテキストとして渡し、パーソナライズされた健康相談ができるチャット機能。

**技術仕様：**

|項目     |内容                                              |
|-------|------------------------------------------------|
|LLMモデル |Claude Haiku 4.5（コスト効率重視、初期）                    |
|回数制限   |月30回（1日1回ペース）                                   |
|コンテキスト |直近7日の体調・睡眠・歩数、今日の予測結果、要因TOP3、アドバイス              |
|API呼び出し|クライアント → Cloud Functions → Anthropic API → レスポンス|

**システムプロンプトに含める情報：**

```
- ユーザーの直近7日の体調スコア
- 今日の予測リスク（%）と信頼度
- 要因TOP3（どの特徴量が影響しているか）
- 不調の基準（14日平均と閾値）
- 好調日の生活パターン（平均睡眠時間、平均歩数等）
```

**コスト試算（Claude Haiku 4.5）：**

|項目            |単価        |1回あたり      |月30回            |
|--------------|----------|-----------|----------------|
|入力（~1,500トークン）|$0.80/100万|$0.0012    |$0.036          |
|出力（~800トークン）  |$4.00/100万|$0.0032    |$0.096          |
|**合計**        |          |**$0.0044**|**$0.132（約¥20）**|

- 1ユーザーあたり月¥20のAPI費用に対して¥980の課金 → **粗利率97%以上**
- 1,000ユーザーでも月¥20,000のAPI費用

**チャットの制限事項：**

- 医療診断・処方に関する質問には回答しない（免責）
- 「医師に相談してください」への適切な誘導
- 過去のチャット履歴は端末ローカルに保存（Firestoreに保存しない → コスト抑制）

**UI配置：**

- ホームタブまたは分析タブに「AIに相談する」ボタンを配置
- 無料ユーザーにはロック表示 + プレミアムへの誘導

### 収益シミュレーション

|ユーザー数  |無料(80%)|スタンダード(15%)|プレミアム(5%)|月間売上      |API費用  |粗利        |
|-------|-------|-----------|---------|----------|-------|----------|
|100人   |80     |15         |5        |¥12,100   |¥100   |¥12,000   |
|1,000人 |800    |150        |50       |¥121,000  |¥1,000 |¥120,000  |
|10,000人|8,000  |1,500      |500      |¥1,210,000|¥10,000|¥1,200,000|


> **前提**: 課金転換率は無料→スタンダード15%、無料→プレミアム5%を想定（ヘルスケアアプリの平均転換率5〜10%より強気だが、無料プランの充実度が高いため継続率は高いと仮定）。

### プラン導入のタイムライン

|フェーズ   |タイミング     |内容                    |
|-------|----------|----------------------|
|Phase 1|初回リリース    |全機能無料で公開、ユーザー獲得に集中    |
|Phase 2|リリース後1〜2ヶ月|スタンダードプラン追加（レポート・7日予測）|
|Phase 3|リリース後2〜3ヶ月|プレミアムプラン追加（AIチャット）    |


> **設計根拠**: 初期に有料化すると、レビュー数・ユーザー数が伸びない。まず無料で十分な価値を提供し、「もっと欲しい」という需要を確認してから有料機能を投入する。

-----

## 18. 将来的な拡張（未確定）

- AIチャットのモデルアップグレード（Haiku → Sonnet、より高品質な回答）
- ウェアラブルデバイスとの高度な連携（心拍数、HRV等）
- 複数人での体調共有機能（家族・チーム向け）
- 企業向けプラン（従業員の健康管理）

-----

## 実装優先度（MVP）

|優先度|タスク          |備考               |
|---|-------------|-----------------|
|1  |体調5段階入力のUI実装 |顔アイコン1タップ        |
|2  |体調時系列特徴量の追加  |前日体調・移動平均・差分・偏差  |
|3  |今日のリスクのみ開放   |3日リスクは60日以降      |
|4  |信頼度はルールベース3段階|model_statusに項目追加|
|5  |週次フィードバック導線  |1タップフィードバック      |

-----

## 変更履歴

|日付        |変更内容                                         |根拠                                                           |
|----------|---------------------------------------------|-------------------------------------------------------------|
|2026-02-06|体調スコア: 3段階 → 5段階                             |分散確保・予測精度向上                                                  |
|2026-02-06|3日リスク: MVP非開放（60日以降に段階開放）                    |初期精度の信頼性担保                                                   |
|2026-02-06|3日ラベル: t+3 → OR(t+1..t+3)                    |正例数増加・学習安定                                                   |
|2026-02-06|特徴量追加: 体調時系列・偏差系                             |入力負担ゼロで予測力向上                                                 |
|2026-02-06|LightGBM切替条件: 60日 AND 不調10件                  |サンプル数担保                                                      |
|2026-02-06|信頼度設計を新設                                     |予測外れ時の離脱防止                                                   |
|2026-02-06|外れフォロー設計を新設                                  |エンゲージメント・予測改善                                                |
|2026-02-06|model_statusにフィールド追加                         |unhealthyCount, recentMissingRate, modelType, confidenceLevel|
|2026-02-06|date_key定義を明確化（ローカルTZ + UTC保存 + tz_at_wake）  |TZ変更・海外移動時の事故防止                                              |
|2026-02-06|休日フラグ: MVPは is_weekend のみ                    |祝日APIは後回しで実装軽量化                                              |
|2026-02-06|14日未満の不調定義ルール追加                              |エッジケースでの実装事故防止                                               |
|2026-02-06|時系列特徴量のリーク防止ルール明記                            |t-1以前のみ使用可、mood(t)は入力に入れない                                   |
|2026-02-06|model_statusのカウント定義を明確化                      |daysCollected=moodScore存在日、unhealthyCount=y=1の日              |
|2026-02-06|predictions に generatedAt, modelVersion 追加   |デバッグ・原因追跡用                                                   |
|2026-02-06|バッチ実行時刻を 03:30 JST に固定                       |アプリ側の表示タイミング設計明確化                                            |
|2026-02-06|不均衡データ対処方針を追加                                |デフォルトは何もしない→必要時のみ重み付け。偽陽性を特に重視                               |
|2026-02-06|LightGBM切替: 単純切替 → 両方学習＋検証比較方式に変更            |60日時点ではロジ回帰が安定するケースが多いため自動比較を採用                              |
|2026-02-07|体調時系列特徴量の表記をt-1時点で統一（delta1, dev14等）         |リーク防止ルールとの矛盾解消                                               |
|2026-02-07|「当日朝までのデータ」の範囲を厳密に定義                         |睡眠=当日起床分、体調/歩数/ストレス=t-1以前                                    |
|2026-02-07|検証スコアの分割方法を明記（直近14日検証、指標AUC）                 |実装時の迷い防止                                                     |
|2026-02-07|バッチ対象ユーザー抽出ルール追加（直近2日更新のみ）                   |スケール時のコスト・速度対策                                               |
|2026-02-12|改善アドバイス自動生成機能を追加（セクション12）                    |リスク表示だけでは行動変容に繋がらないため                                        |
|2026-02-12|特徴量寄与度表示機能を追加（セクション13）                       |予測の説明性向上・ユーザーの納得感確保                                          |
|2026-02-12|データ量ベースのハイパーパラメータ段階設計を追加                     |過学習防止とデータ規模に応じた柔軟性の両立                                        |
|2026-02-12|アドバイスを具体的数値付き（推奨睡眠時間・就寝時刻等）に強化               |行動変容の促進                                                      |
|2026-02-12|ヘルスケア連携（Apple Health / Google Fit）を無料MVP機能に変更|ユーザー入力負担の軽減                                                  |
|2026-02-12|特徴量比較グラフを追加（体調×任意特徴量の2軸表示）                   |学習データの透明性確保                                                  |
|2026-02-12|睡眠パターン専用グラフを追加（就寝・起床時刻のバー表示）                 |時刻データは数値グラフと性質が異なるため分離                                       |
|2026-02-12|検証分割を固定14日からデータ量ベースの段階設計に変更                  |少量データ時の学習データ不足と大量データ時の直近学習除外を両方回避                            |
|2026-02-13|過去データ編集機能を追加（直近3日、全項目対象）                     |入力忘れ・ミス修正のニーズ対応                                              |
|2026-02-14|UI設計を追加: 4タブ構成（ホーム/データ/分析/設定）+ 画面遷移図         |入力と振り返り/分析の目的別分離                                             |
|2026-02-14|不調の基準をユーザーに明示する表示設計を追加                       |予測への納得感・透明性確保                                                |
|2026-02-15|グラフの期間別表示方法を詳細化（30日・全期間で7日移動平均を重ねる）          |長期間グラフの視認性確保                                                 |
|2026-02-15|3段階サブスクリプション設計を追加（無料/スタンダード¥480/プレミアム¥980）   |既存機能は全て無料、新機能で有料化                                            |
|2026-02-15|AIヘルスチャット設計を追加（Claude Haiku、月30回、コンテキスト付き）   |プレミアムプランの目玉機能                                                |
|2026-02-15|プラン導入タイムラインを追加（Phase 1〜3）                    |初期は無料でユーザー獲得に集中                                              |